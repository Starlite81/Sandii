<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>‚ù§Ô∏èSandiiü•π</title>
<style>
:root{--gold:#D4AF37;--gold-dark:#a78123;--bg:#FFF9ED;}
body{margin:0;font-family:Inter,sans-serif;background:linear-gradient(180deg,#fffaf0,var(--bg));display:flex;flex-direction:column;height:100vh;}
header{padding:12px 16px;background:linear-gradient(90deg,var(--gold),var(--gold-dark));color:#111;font-weight:700;position:relative;}
.sub{font-weight:600;font-size:16px;}
#logout{position:absolute;right:12px;top:10px;font-size:13px;color:#111;background:rgba(255,255,255,0.6);padding:6px 8px;border-radius:8px;cursor:pointer;}
#status{font-size:13px;color:#111;opacity:0.95;margin-top:6px;}
.container{display:flex;flex:1;gap:12px;padding:12px;overflow:hidden;}
.sidebar{width:260px;background:rgba(255,255,255,0.6);border-radius:14px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);display:flex;flex-direction:column;gap:10px;overflow:auto;}
#usersList{flex:1;overflow:auto;}
.userRow{display:flex;gap:10px;align-items:center;padding:8px;border-radius:10px;cursor:pointer;}
.userRow:hover{background:rgba(0,0,0,0.03);}
.avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;}
.userMeta{font-size:13px;}
.userName{font-weight:700;}
.userStatus{font-size:12px;color:#666;}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
#chatBox{flex:1;overflow-y:auto;padding:18px;display:flex;flex-direction:column;gap:12px;border-radius:12px;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300"><rect width="100%" height="100%" fill="%23fff7ea"/></svg>');}
.bubble{padding:12px 14px;max-width:72%;border-radius:18px;box-shadow:0 6px 14px rgba(0,0,0,0.06);word-break:break-word;position:relative;}
.mine{margin-left:auto;background:linear-gradient(180deg,#fff7e6,#fff5df);border-bottom-right-radius:6px;text-align:right;}
.other{margin-right:auto;background:#ffffff;border-bottom-left-radius:6px;text-align:left;}
.msgHeader{display:flex;gap:8px;align-items:center;}
.msgText{margin-top:6px;font-size:15px;}
.msgMeta{display:flex;gap:8px;align-items:center;justify-content:flex-end;font-size:12px;color:#666;margin-top:8px;}
.small{font-size:12px;color:#777;}
#bar{display:flex;padding:12px;gap:8px;background:transparent;align-items:center;}
#msgInput{flex:1;padding:12px 14px;border-radius:18px;border:1px solid rgba(0,0,0,0.09);outline:none;font-size:15px;background:rgba(255,255,255,0.9);}
#sendBtn{background:linear-gradient(90deg,var(--gold),var(--gold-dark));border:none;padding:10px 16px;border-radius:18px;font-weight:700;cursor:pointer;color:#111;}
.fileBtn{background:transparent;border:1px dashed rgba(0,0,0,0.06);padding:8px;border-radius:10px;cursor:pointer;}
.typing{font-size:13px;color:#444;padding:6px 12px;}
.replyLabel{font-size:12px;color:#555;margin-bottom:4px;font-style:italic;}
.voiceBtn{background:#2b6cb0;color:#fff;padding:8px 12px;border-radius:12px;border:none;cursor:pointer;margin-left:6px;}
</style>
</head>
<body>

<header>
  <div class="sub">‚ù§Ô∏èSandiiü•π</div>
  <div id="logout">Logout</div>
  <div id="status">Loading chat‚Ä¶</div>
</header>

<div class="container">
  <aside class="sidebar">
    <div style="font-weight:800">Contacts</div>
    <div id="usersList"></div>
    <div class="footerNote">Online, avatars, seen ticks, typing & images</div>
  </aside>
  <main class="main">
    <div id="chatBox" aria-live="polite"></div>
    <div class="typing" id="typingIndicator" style="display:none">Someone is typing‚Ä¶</div>
    <div id="bar">
      <input id="fileInput" type="file" accept="image/*" style="display:none" />
      <button id="attachBtn" class="fileBtn" title="Attach image">üìé</button>
      <input id="msgInput" type="text" placeholder="Type your message..." autocomplete="off" />
      <button id="sendBtn">Send</button>
      <button id="voiceBtn" class="voiceBtn">üé§</button>
    </div>
  </main>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, set, onValue, onDisconnect, query, limitToLast } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAWcThQ9FoieRoG9DJbzSaRwOqfmg65ykk",
  authDomain: "chatty-fbb90.firebaseapp.com",
  databaseURL: "https://chatty-fbb90-default-rtdb.firebaseio.com",
  projectId: "chatty-fbb90",
  storageBucket: "chatty-fbb90.firebasestorage.app",
  messagingSenderId: "44728958212",
  appId: "1:44728958212:web:9c7068e885943896d3e451"
};

const app = initializeApp(FIREBASE_CONFIG);
const db = getDatabase(app);
const auth = getAuth(app);

const chatBox = document.getElementById('chatBox');
const msgInput = document.getElementById('msgInput');
const sendBtn  = document.getElementById('sendBtn');
const voiceBtn = document.getElementById('voiceBtn');
const logoutBtn = document.getElementById('logout');
const typingIndicator = document.getElementById('typingIndicator');
const attachBtn = document.getElementById('attachBtn');
const fileInput = document.getElementById('fileInput');
const usersList = document.getElementById('usersList');

const incomingAudio = new Audio();
incomingAudio.src = 'data:audio/mp3;base64,//uQZAAAAAAAAAAAAAA...';

const nameMap = {"cosmas@gmail.com":"COSMAS‚ù§Ô∏è","sandii@gmail.com":"SANDRA‚ù§Ô∏è"};

function mapName(email){ return nameMap[email] || email; }
function fmtTime(ts){ return new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
function colorFromString(s){let h=0; for(let i=0;i<s.length;i++){h = s.charCodeAt(i) + ((h<<5)-h);} return '#' + Math.abs(h).toString(16).slice(0,6).padEnd(6,'0'); }
function avatarEl(name){ const span=document.createElement('div'); span.className='avatar'; span.style.background=colorFromString(name); span.textContent=(name||'?').trim().split(' ').map(p=>p[0]?.toUpperCase()).slice(0,2).join(''); return span; }

let replyTo = null;

function addBubble(msg,key){
  if(!msg || document.getElementById('msg-'+key)) return;
  const meEmail = auth.currentUser?.email;
  const isMine = meEmail && msg.email===meEmail;

  const wrap = document.createElement('div');
  wrap.id='msg-'+key;
  wrap.className='bubble ' + (isMine?'mine':'other');

  const header = document.createElement('div'); header.className='msgHeader';
  const av = avatarEl(mapName(msg.email));
  av.style.width='36px'; av.style.height='36px'; av.style.flex='0 0 36px';
  if(!isMine) header.appendChild(av);

  const nameWrap = document.createElement('div');
  nameWrap.innerHTML=`<div class="userName">${escapeHtml(mapName(msg.email))}</div>`;
  header.appendChild(nameWrap);

  const text = document.createElement('div'); text.className='msgText';
  if(msg.type==='image' && msg.imageData){ const img=document.createElement('img'); img.src=msg.imageData; img.style.maxWidth='320px'; img.style.borderRadius='12px'; img.style.display='block'; text.appendChild(img);}
  else text.innerHTML=escapeHtml(msg.text||'');

  const meta = document.createElement('div'); meta.className='msgMeta';
  const time=document.createElement('div'); time.textContent=fmtTime(msg.ts||Date.now()); meta.appendChild(time);
  const ticks=document.createElement('div'); ticks.className='small'; ticks.textContent=isMine?((msg.seenBy?Object.keys(msg.seenBy).length:0)>0?'‚úì‚úì':'‚úì') : ''; meta.appendChild(ticks);

  wrap.appendChild(header);
  wrap.appendChild(text);
  wrap.appendChild(meta);
  chatBox.appendChild(wrap);
  chatBox.scrollTop=chatBox.scrollHeight;

  if(!isMine){ try{incomingAudio.play().catch(()=>{});}catch(e){} }

  // swipe to reply
  let startX=0;
  wrap.addEventListener('touchstart',e=>{ startX=e.touches[0].clientX; });
  wrap.addEventListener('touchend',e=>{
    const endX=e.changedTouches[0].clientX;
    if(endX-startX>80){ replyTo = mapName(msg.email)+": "+(msg.text||''); msgInput.focus(); msgInput.value=replyTo+'\n'; }
  });
}

let typingTimer=null;
function setTyping(flag){
  const uid = auth.currentUser?.uid; if(!uid) return;
  const tRef = ref(db,`typing/${uid}`); set(tRef, flag?Date.now():null);
}
msgInput.addEventListener('input', ()=>{
  setTyping(true); clearTimeout(typingTimer); typingTimer=setTimeout(()=>{ setTyping(false); },1500);
});

onValue(ref(db,'typing'),snap=>{
  const v=snap.val()||{};
  const meUid=auth.currentUser?.uid;
  typingIndicator.style.display=Object.keys(v).some(k=>k!==meUid && v[k])?'block':'none';
});

function setPresence(uid){ if(!uid) return; const myStatusRef=ref(db,`status/${uid}`); set(myStatusRef,{online:true,lastActive:Date.now()}); onDisconnect(myStatusRef).set({online:false,lastActive:Date.now()}); }

function renderUsersList(users){
  usersList.innerHTML='';
  for(const uid in users){
    const u=users[uid];
    const row=document.createElement('div'); row.className='userRow';
    row.appendChild(avatarEl(mapName(u.email)));
    const meta=document.createElement('div'); meta.className='userMeta';
    meta.innerHTML=`<div class="userName">${escapeHtml(mapName(u.email))}</div>
                    <div class="userStatus">${u.online?'Online':'Last seen '+(u.lastActive?new Date(u.lastActive).toLocaleString():'Unknown')}</div>`;
    row.appendChild(meta); usersList.appendChild(row);
  }
}

const messagesRef = ref(db,'messages');
const usersRef = ref(db,'users');
const statusRefRoot = ref(db,'status');

onValue(statusRefRoot,snap=>{
  const s=snap.val()||{};
  onValue(usersRef,usnap=>{
    const users=usnap.val()||{};
    for(const uid in s){ users[uid]=users[uid]||{}; users[uid].online=s[uid].online; users[uid].lastActive=s[uid].lastActive; }
    renderUsersList(users);
  });
});

function attachMessagesListener(){
  const recentQuery=query(messagesRef,limitToLast(500));
  onChildAdded(recentQuery,snapshot=>{
    const key=snapshot.key; const msg=snapshot.val(); if(!msg) return;
    const meUid=auth.currentUser?.uid;
    if(meUid && (!msg.seenBy || !msg.seenBy[meUid])) set(ref(db,`messages/${key}/seenBy/${meUid}`),true);
    addBubble(msg,key);
  });
}

async function sendMessage(payload){ try{ await push(messagesRef,payload); }catch(e){console.error('Send failed',e);} }

sendBtn.addEventListener('click',async()=>{
  const text=msgInput.value.trim(); if(!text) return;
  sendBtn.disabled=true;
  const user=auth.currentUser;
  await sendMessage({ name:user.displayName||user.email, email:user.email, uid:user.uid, text, ts:Date.now(), type:'text' });
  msgInput.value=''; replyTo=null; setTyping(false); sendBtn.disabled=false;
});

// disable Enter sending
msgInput.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); } });

// attach image
attachBtn.addEventListener('click',()=>fileInput.click());
fileInput.addEventListener('change',()=>{
  const f=fileInput.files[0]; if(!f) return; const reader=new FileReader();
  reader.onload=async()=>{ await sendMessage({ name:auth.currentUser.displayName||auth.currentUser.email, email:auth.currentUser.email, uid:auth.currentUser.uid, text:'', ts:Date.now(), type:'image', imageData:reader.result }); fileInput.value=''; };
  reader.readAsDataURL(f);
});

// record voice note
let mediaRecorder=null; let audioChunks=[];
voiceBtn.addEventListener('click',async()=>{
  if(mediaRecorder && mediaRecorder.state==='recording'){ mediaRecorder.stop(); return; }
  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  mediaRecorder=new MediaRecorder(stream);
  audioChunks=[];
  mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);
  mediaRecorder.onstop=async()=>{
    const audioBlob=new Blob(audioChunks,{type:'audio/webm'}); const reader=new FileReader();
    reader.onload=async()=>{ await sendMessage({ name:auth.currentUser.displayName||auth.currentUser.email, email:auth.currentUser.email, uid:auth.currentUser.uid, text:'', ts:Date.now(), type:'voice', audioData:reader.result }); };
    reader.readAsDataURL(audioBlob);
  };
  mediaRecorder.start();
});

logoutBtn.onclick=()=>signOut(auth).then(()=>{ sessionStorage.clear(); localStorage.clear(); window.location.href='index.html'; });

onAuthStateChanged(auth,user=>{
  if(user){
    setPresence(user.uid);
    set(ref(db,`users/${user.uid}`),{ name:user.displayName||user.email,email:user.email });
    attachMessagesListener();
  } else { setTimeout(()=>{ window.location.href='index.html'; },400); }
});

</script>
</body>
</html>
